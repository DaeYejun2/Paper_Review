# 리눅스 및 ESXi 클라우드 호스트 환경에서의 랜섬웨어 행위 분석 리뷰

최진우(학부생), 김진우 교수님의 
"리눅스 및 ESXi 클라우드 호스트 환경에서의 랜섬웨어 행위 분석." 한국정보처리학회(ACK) 또는 관련 학술대회 발표 논문을 정리한 글입니다.

### 요약
본 논문에서는 최근 클라우드에서 가상머신(VM)을 표적으로 공격하는 랜섬웨어 샘플들을 리눅스 호스트 및 ESXi 호스트 환경에 배포하여 분석하였다.
분석 결과, 대부분의 랜섬웨어 샘플들이 ESXi 호스트 디스크 저장소 경로인 /vmsf/volumes/를 암호화하는 동작을 관찰하였다.
가상 머신 디스크 파일((VMDK) 및 스냅샷 등 VM 관련 파일들이 해당 경로에 저장된다는 점을 고려할 때, 이러한 클라우드 랜섬웨어들은 단일 물리 호스트에서 다수의 VM을 동시에 손상시킬 수 있어 매우 치명적이다.

### 배경 지식 
* ESXi 하이퍼바이저
  ESXi는 VMware vSphere의 타입-1(베어메탈) 하이퍼바이저로, 범용 OS 없이 하드웨어 위에서 직접 동작하여 가상머신을 실행한다.
  VMkernel이 CPU·메모리·네트워크·디스크를 관리하며, vCenter Server가 다수 ESXi 호스트를 중앙 관리하는 구조를 가지고 있다.
  VMware 솔루션이 여전히 가상화 시장에서 높은 점유율을 차지하고 있음을 통해 ESXi가 여전히 널리 채택되고 있음을 유추할 수 있다.

* 클라우드 랜섬웨어
  클라우드 랜섬웨어는 ESXi와 같은 하이퍼바이저에서 구동하는 VM들을 특정하여 암호화하는 악성 코드를 지칭하며, 일반적으로 5가지 단계로 공격을 수행한다.
  1. 초기 침입

     피싱, 취약점 악용 등으로 **최초 접근권 확보**
     
  2. 횡적 이동 및 권한 상승

     초기 침입 이후, 다른 관리 시스템으로 이동하며 **중앙 관리자 권한 확보**
     
  3. 호스트 침해 및 셸 획득

     SSH 원격 세션 등을 통해 ESXi 호스트에서 **셸 환경 확보**

  4. 사전작업

     복구 가능성을 낮추기 위한 **스냅샷 삭제, VM 종료** 등의 활동

  5. 암호화

     **가상 디스크 파일(\*.vmdk), VM 메모리 백업파일(\*.vmem) 등 암호화**

     * 랜섬노트 생성(암호화 되었음을 알리며, 금전을 요구하는 내용이 담긴 문서)


## 1. 문제
최근 클라우드에서의 랜섬웨어 공격은 가상화 인프라를 직접 표적으로 삼는 양상으로 확산되고 있다. 워크로드가 소수의 하이퍼바이저에 집중되는 클라우드 환경의 특성상, 단일 호스트 감염이 다수 VM의 동시 마비로 이어질 수 있다는 점에서 매우 높은 피해 위험을 가진다.

## 2. 어떻게 분석했는가?
본 연구는 리눅스 기반, ESXi 기반의 총 2가지 환경을 구성하였다.

랜섬웨어를 실행시킬 때는 네트워크 디바이스를 제거하여, Proxmox 호스트 및 외부 네트워크와 차단된 상태에서 진행되었다.

동적 분석에는 VMware Threat Report 2022에서 제공한 malware dataset 중 랜섬웨어 샘플 66개가 사용되었다.

<img width="459" height="428" alt="image" src="https://github.com/user-attachments/assets/2eb57051-218a-4210-a332-f8a1a415702d" />

*사용 샘플 요약*


## 3. 무엇을 새로 알아냈는가?
#### 리눅스 환경에서 동적 분석

샘플들이 리눅스 환경에서 /vmfs/volumes/ 경로를 암호화하는지 실험 수행

대부분의 샘플들이 암호화 진행, 랜섬 노트 생성

일부 샘플들은 ESXI의 가상머신 디스크 파일의 경로를 암호화할 수 있다. 또한 Darkside, REvil 패밀리처럼 /vmfs/volumes/ 경로를 명시적으로 하드코딩 하거나, -s 옵션 등으로 VM을 종료시키는 등의 ESXi 환경도 함께 목표로 하는 샘플들도 확인할 수 있었다.

#### ESXi 환경에서의 동적 분석

리눅스 환경에서 /vmfs/volumes/ 경로를 암호화한다는 것을 확인했으므로, 동일한 샘플들이 ESXi 환경에서도 가상머신 디스크 파일을 암호화할 수 있는지를 검증하기 위한 실험 수행

Darkside 패밀리에 속하는 샘플

공격자가 루트 권한을 가지며, 바이너리가 /bin/ 디렉터리에서 실행되는 것으로 가정하였다. ESXi 환경에서 /vmfs/volumes/ 경로 내의 .vmdk 파일이 .darkside 확장자로 암호화되었고, darkside_readme.txt라는 랜섬노트가 생성된 것을 확인할 수 있다. 


## 4. 결론 및 향후 연구
본 연구에서는 클라우드 랜섬웨어 샘플이 ESXi 호스트 가상머신 디스크 파일이 저장되는 /vmfs/volumes/ 경로를 명시적으로 타깃으로 삼고 있음을 동적 분석을 통해 확인하였다. 또한 그 중 일부는 ESXi 환경에서 정상적으로 동작하며 .vmdk 파일 등을 암호화하여 가상머신의 가용성을 손상시킴을 확인하였다.

Transformer 모델을 활용해 이러한 행위들을 로그 기반으로 자동 탐지하는 시계열 패턴 파악, 이상치 탐지 기술이 필수적일 것 같다.

간단 작동 프로세스
1. 데이터 전처리
   ESXi 호스트에서 발생하는 무수히 많은 로그 메시지를 고유 번호를 부여하는 식으로 모델이 이해할 수 있는 형태로 바꾼다.

2. 맥락 파악
   관리자가 정상적으로 VM을 종료하는 로그와, 랜섬웨어가 esxcli를 사용해 강제로 끄는 로그는 전후 맥락이 다를 테니, 이러한 차이를 이용한다.

3. 탐지 및 분류
   로그 패턴이 정상인지 공격인지 로그 시퀸스를 보고 판단한다.

   만약 공격 패턴이라면 공격의 특징을 이용해 Darkside인지, REvil인지 분류까지 할 수 있겠다. 
